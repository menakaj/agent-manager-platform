name: Build and Push

on:
  release:
    types: [created]

env:
  REGISTRY: ghcr.io
  REGISTRY_ORG: menakaj
  HELM_REGISTRY: oci://ghcr.io/menakaj

jobs:
  build-and-push:
    name: Build and Push
    runs-on: ubuntu-latest
    concurrency:
      group: build-push-${{ github.event.release.tag_name }}
      cancel-in-progress: false
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Extract release tag and version
        id: version
        run: |
          bash .github/scripts/extract-version.sh "${{ github.event.release.tag_name }}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push agent-manager-service
        id: build-agent-manager
        uses: ./.github/actions/build-docker-image
        with:
          service: agent-manager-service
          registry: ${{ env.REGISTRY }}
          registry-org: ${{ env.REGISTRY_ORG }}
          tag: ${{ steps.version.outputs.tag }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      # - name: Build and push console
      #   id: build-console
      #   uses: ./.github/actions/build-docker-image
      #   with:
      #     service: console
      #     registry: ${{ env.REGISTRY }}
      #     registry-org: ${{ env.REGISTRY_ORG }}
      #     tag: ${{ steps.version.outputs.tag }}
      #     github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push traces-observer-service
        id: build-traces-observer
        uses: ./.github/actions/build-docker-image
        with:
          service: traces-observer-service
          registry: ${{ env.REGISTRY }}
          registry-org: ${{ env.REGISTRY_ORG }}
          tag: ${{ steps.version.outputs.tag }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Track pushed images
        id: track-images
        run: |
          SERVICES="agent-manager-service|console|traces-observer-service"
          echo "services=$SERVICES" >> $GITHUB_OUTPUT
          echo "Pushed images tracked: $SERVICES"
        shell: bash

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.14.0'

      - name: Install yq
        uses: mikefarah/yq@v4
        with:
          version: v4.40.5

      - name: Push agent-management-platform chart
        id: chart-amp
        run: |
          CHART_NAME="agent-management-platform"
          CHART_DIR="./deployment/helm-charts/agent-management-platform"
          
          # Log in to registry
          ACTOR="${GITHUB_ACTOR:-github-actions}"
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login -u "$ACTOR" --password-stdin "${{ env.REGISTRY }}"
          
          # Package and push
          helm package "$CHART_DIR" --version "${{ steps.version.outputs.version }}"
          helm push "${CHART_NAME}-${{ steps.version.outputs.version }}.tgz" "${{ env.HELM_REGISTRY }}/${CHART_NAME}"
          echo "chart=agent-management-platform" >> $GITHUB_OUTPUT
          echo "✅ Pushed agent-management-platform chart version ${{ steps.version.outputs.version }}"
        shell: bash

      - name: Push build-ci chart
        id: chart-build-ci
        run: |
          CHART_NAME="build-ci"
          CHART_DIR="./deployment/helm-charts/build-ci"
          
          # Log in to registry
          ACTOR="${GITHUB_ACTOR:-github-actions}"
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login -u "$ACTOR" --password-stdin "${{ env.REGISTRY }}"
          
          # Package and push
          helm package "$CHART_DIR" --version "${{ steps.version.outputs.version }}"
          helm push "${CHART_NAME}-${{ steps.version.outputs.version }}.tgz" "${{ env.HELM_REGISTRY }}/${CHART_NAME}"
          echo "chart=build-ci" >> $GITHUB_OUTPUT
          echo "✅ Pushed build-ci chart version ${{ steps.version.outputs.version }}"
        shell: bash

      - name: Push observability-dataprepper chart
        id: chart-observability
        run: |
          CHART_NAME="observability-dataprepper"
          CHART_DIR="./deployment/helm-charts/observability-dataprepper"
          
          # Log in to registry
          ACTOR="${GITHUB_ACTOR:-github-actions}"
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login -u "$ACTOR" --password-stdin "${{ env.REGISTRY }}"
          
          # Package and push
          helm package "$CHART_DIR" --version "${{ steps.version.outputs.version }}"
          helm push "${CHART_NAME}-${{ steps.version.outputs.version }}.tgz" "${{ env.HELM_REGISTRY }}/${CHART_NAME}"
          echo "chart=observability-dataprepper" >> $GITHUB_OUTPUT
          echo "✅ Pushed observability-dataprepper chart version ${{ steps.version.outputs.version }}"
        shell: bash

      - name: Track pushed charts
        id: track-charts
        run: |
          CHARTS="agent-management-platform|build-ci|observability-dataprepper"
          echo "charts=$CHARTS" >> $GITHUB_OUTPUT
          echo "Pushed charts tracked: $CHARTS"
        shell: bash

      - name: Mark build and push as successful
        if: success()
        run: |
          echo "✅ Build and push completed successfully"
          echo "All images and charts pushed successfully"
        shell: bash

      - name: Cleanup on failure
        if: failure()
        uses: ./.github/actions/cleanup-release
        with:
          registry: ${{ env.REGISTRY }}
          registry-org: ${{ env.REGISTRY_ORG }}
          tag: ${{ steps.version.outputs.tag }}
          helm-registry: ${{ env.HELM_REGISTRY }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          services: ${{ steps.track-images.outputs.services }}
          charts: ${{ steps.track-charts.outputs.charts }}

      - name: Fail workflow on error
        if: failure()
        run: |
          echo "❌ Build and push failed - cleanup completed"
          exit 1
        shell: bash

