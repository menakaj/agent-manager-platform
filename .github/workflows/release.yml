name: Release

on:
  release:
    types: [created]

env:
  REGISTRY: ghcr.io
  REGISTRY_ORG: menakaj
  HELM_REGISTRY: oci://ghcr.io/menakaj

jobs:
  release:
    name: Atomic Release Process
    runs-on: ubuntu-latest
    concurrency:
      group: release-${{ github.event.release.tag_name }}
      cancel-in-progress: false
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Extract release tag and version
        id: version
        run: |
          bash .github/scripts/extract-version.sh "${{ github.event.release.tag_name }}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push agent-manager-service
        id: build-agent-manager
        uses: ./.github/actions/build-docker-image
        with:
          service: agent-manager-service
          registry: ${{ env.REGISTRY }}
          registry-org: ${{ env.REGISTRY_ORG }}
          tag: ${{ steps.version.outputs.tag }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      # - name: Build and push console
      #   id: build-console
      #   uses: ./.github/actions/build-docker-image
      #   with:
      #     service: console
      #     registry: ${{ env.REGISTRY }}
      #     registry-org: ${{ env.REGISTRY_ORG }}
      #     tag: ${{ steps.version.outputs.tag }}
      #     github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push traces-observer-service
        id: build-traces-observer
        uses: ./.github/actions/build-docker-image
        with:
          service: traces-observer-service
          registry: ${{ env.REGISTRY }}
          registry-org: ${{ env.REGISTRY_ORG }}
          tag: ${{ steps.version.outputs.tag }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Track pushed images
        id: track-images
        run: |
          SERVICES="agent-manager-service|console|traces-observer-service"
          echo "services=$SERVICES" >> $GITHUB_OUTPUT
          echo "Pushed images tracked: $SERVICES"

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.14.0'

      - name: Install yq
        uses: mikefarah/yq@v4
        with:
          version: v4.40.5

      - name: Update and push agent-management-platform chart
        id: chart-amp
        run: |
          IMAGE_UPDATES=".agentManagerService.image:${{ env.REGISTRY }}/${{ env.REGISTRY_ORG }}/agent-manager-service:${{ steps.version.outputs.tag }}|.console.image:${{ env.REGISTRY }}/${{ env.REGISTRY_ORG }}/console:${{ steps.version.outputs.tag }}"
          bash .github/scripts/update-helm-chart.sh \
            "agent-management-platform" \
            "./deployment/helm-charts/agent-management-platform" \
            "${{ steps.version.outputs.version }}" \
            "${{ steps.version.outputs.tag }}" \
            "${{ env.HELM_REGISTRY }}" \
            "${{ env.REGISTRY }}" \
            "${{ env.REGISTRY_ORG }}" \
            "${{ secrets.GITHUB_TOKEN }}" \
            "$IMAGE_UPDATES"
          echo "chart=agent-management-platform" >> $GITHUB_OUTPUT

      - name: Update and push build-ci chart
        id: chart-build-ci
        run: |
          bash .github/scripts/update-helm-chart.sh \
            "build-ci" \
            "./deployment/helm-charts/build-ci" \
            "${{ steps.version.outputs.version }}" \
            "${{ steps.version.outputs.tag }}" \
            "${{ env.HELM_REGISTRY }}" \
            "${{ env.REGISTRY }}" \
            "${{ env.REGISTRY_ORG }}" \
            "${{ secrets.GITHUB_TOKEN }}" \
            ""
          echo "chart=build-ci" >> $GITHUB_OUTPUT

      - name: Update and push observability-dataprepper chart
        id: chart-observability
        run: |
          IMAGE_UPDATES=".tracesObserverService.image:${{ env.REGISTRY }}/${{ env.REGISTRY_ORG }}/traces-observer-service:${{ steps.version.outputs.tag }}"
          bash .github/scripts/update-helm-chart.sh \
            "observability-dataprepper" \
            "./deployment/helm-charts/observability-dataprepper" \
            "${{ steps.version.outputs.version }}" \
            "${{ steps.version.outputs.tag }}" \
            "${{ env.HELM_REGISTRY }}" \
            "${{ env.REGISTRY }}" \
            "${{ env.REGISTRY_ORG }}" \
            "${{ secrets.GITHUB_TOKEN }}" \
            "$IMAGE_UPDATES"
          echo "chart=observability-dataprepper" >> $GITHUB_OUTPUT

      - name: Track pushed charts
        id: track-charts
        run: |
          CHARTS="agent-management-platform|build-ci|observability-dataprepper"
          echo "charts=$CHARTS" >> $GITHUB_OUTPUT
          echo "Pushed charts tracked: $CHARTS"

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Update chart versions in install-helpers.sh
        run: |
          bash .github/scripts/update-install-helpers.sh \
            "${{ steps.version.outputs.version }}" \
            "./quick-start/install-helpers.sh"

      - name: Commit and push changes
        id: commit-changes
        run: |
          git add ./quick-start/install-helpers.sh
          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "committed=false" >> $GITHUB_OUTPUT
          else
            git commit -m "chore: update chart versions to ${{ steps.version.outputs.tag }}"
            git push
            echo "committed=true" >> $GITHUB_OUTPUT
            echo "Committed and pushed chart version updates"
          fi

      - name: Create release artifacts
        id: artifacts
        run: |
          bash .github/scripts/create-release-artifacts.sh \
            "${{ steps.version.outputs.tag }}" \
            "./quick-start" \
            "quick-start"

      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ steps.artifacts.outputs.archive }}
            ${{ steps.artifacts.outputs.checksum }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Mark release as successful
        if: success()
        run: |
          echo "✅ Release completed successfully"
          echo "All images and charts pushed successfully"

      - name: Cleanup on failure
        if: failure()
        uses: ./.github/actions/cleanup-release
        with:
          registry: ${{ env.REGISTRY }}
          registry-org: ${{ env.REGISTRY_ORG }}
          tag: ${{ steps.version.outputs.tag }}
          helm-registry: ${{ env.HELM_REGISTRY }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          services: ${{ steps.track-images.outputs.services }}
          charts: ${{ steps.track-charts.outputs.charts }}

      - name: Revert git commit on failure
        if: failure() && steps.commit-changes.outputs.committed == 'true'
        run: |
          echo "Reverting git commit..."
          git reset --hard HEAD~1 || true
          git push --force || true
          echo "✅ Git changes reverted"
        shell: bash

      - name: Fail workflow on error
        if: failure()
        run: |
          echo "❌ Release failed - cleanup completed"
          exit 1
        shell: bash
